import"../chunks/DsnmJJEf.js";import"../chunks/B6xteeIL.js";import{M as Fe,R as X,V as n,W as F,D as v,C as e,T as Qe,H as k,I as r,J as s,P as d,N as R,Q as U,U as xe,o as l,O as Re,m as Ne,n as Se,b5 as Ke,u as b,b6 as _e,aD as oe,ac as dt,aB as gt,b7 as mt,b8 as _t}from"../chunks/J53a5pXB.js";import{i as Ve}from"../chunks/Ce3FM-Or.js";import{p as D,i as N,a as bt,b as wt}from"../chunks/CVWE5XDX.js";import{g as yt}from"../chunks/qLTqb0RQ.js";import{s as ze,c as et,b as Pe,e as vt,i as xt,d as Xe,t as St}from"../chunks/DwDLloZq.js";import{a as Ye}from"../chunks/CDx50ljX.js";import{s as Oe}from"../chunks/CORCjSxP.js";import{S as Ze,a as kt,F as $t,A as Ae,T as nt,D as Ct,b as Dt}from"../chunks/BJbLsdG9.js";import{b as Tt}from"../chunks/CNdUi1S-.js";function Et(x,a,c){return`temp_${x}_${a}_${c}`}function At(x){const a=x.split(`
`).filter(h=>h.trim());if(a.length<2)return{transactions:[],errors:[{row:0,message:"CSV must have header and at least one data row"}],headers:[]};const c=a[0],i=it(c),t=Pt(i),g=[],m=[],_=new Set;for(let h=1;h<a.length;h++)try{const P=it(a[h]);if(P.length===0)continue;const p=Mt(P,t,h+1);p&&(_.has(p.hash)?(p.isDuplicate=!0,p.selected=!1,p.duplicateReason="Identical transaction already exists"):_.add(p.hash),g.push(p))}catch(P){m.push({row:h+1,message:P instanceof Error?P.message:"Unknown parsing error",data:a[h]})}return{transactions:g,errors:m,headers:i}}function it(x){const a=[];let c="",i=!1,t=0;for(;t<x.length;){const g=x[t];g==='"'?i&&x[t+1]==='"'?(c+='"',t+=2):(i=!i,t++):g===","&&!i?(a.push(c.trim()),c="",t++):(c+=g,t++)}return a.push(c.trim()),a}function Pt(x){const a={},c={bookingDate:/booking\s*date|fecha\s*reserva|date|fecha/i,valueDate:/value\s*date|fecha\s*valor/i,partnerName:/partner\s*name|nombre\s*socio|beneficiario|partner|merchant/i,partnerIban:/partner\s*iban|iban\s*socio|iban/i,type:/type|tipo|transaction\s*type/i,paymentReference:/payment\s*reference|referencia\s*pago|concepto|description|descripci[o√≥]n/i,accountName:/account\s*name|nombre\s*cuenta|account/i,amountEur:/amount.*eur|importe.*eur|cantidad|amount|importe/i,originalAmount:/original\s*amount|importe\s*original/i,originalCurrency:/original\s*currency|moneda\s*original/i,exchangeRate:/exchange\s*rate|tipo\s*cambio/i};return x.forEach((i,t)=>{Object.entries(c).forEach(([g,m])=>{m.test(i)&&!a[g]&&(a[g]=t)})}),a}function Mt(x,a,c){try{const i=ot(x[a.bookingDate]||""),t=ot(x[a.valueDate]||""),g=x[a.amountEur]||"0",m=ct(g);let _=Ue(x[a.partnerName]||"");const h=Ue(x[a.paymentReference]||"");if((!_||_.replace(/[^\w\s]/g,"").trim()==="")&&(_="Unknown Merchant"),!i||isNaN(m))throw new Error(`Missing required fields (row ${c})`);const P=i.toISOString().split("T")[0],p=Et(P,_,m);return{id:`temp-${c}-${Date.now()}`,hash:p,date:P,valueDate:t?.toISOString().split("T")[0],partner:_,iban:Ue(x[a.partnerIban]||""),type:Ue(x[a.type]||""),description:h,account:Ue(x[a.accountName]||""),amount:m,originalAmount:a.originalAmount?ct(x[a.originalAmount]):void 0,originalCurrency:Ue(x[a.originalCurrency]||""),exchangeRate:a.exchangeRate?parseFloat(x[a.exchangeRate]):void 0,selected:!0,isDuplicate:!1}}catch(i){throw new Error(`Error processing row ${c}: ${i instanceof Error?i.message:"Unknown error"}`)}}function ot(x){if(!x)return null;const a=[/^(\d{4})-(\d{2})-(\d{2})$/,/^(\d{2})\/(\d{2})\/(\d{4})$/,/^(\d{2})-(\d{2})-(\d{4})$/];for(const i of a){const t=x.match(i);if(t)if(i===a[0]){const g=parseInt(t[1]),m=parseInt(t[2])-1,_=parseInt(t[3]);return new Date(Date.UTC(g,m,_,0,0,0))}else{const g=parseInt(t[1]),m=parseInt(t[2])-1,_=parseInt(t[3]);return new Date(Date.UTC(_,m,g,0,0,0))}}const c=new Date(x);return isNaN(c.getTime())?null:c}function ct(x){if(!x)return 0;const c=x.replace(/[^\d.,+\-]/g,"").replace(/,/g,"."),i=parseFloat(c);return isNaN(i)?0:i}function Ue(x){return x.replace(/^"|"$/g,"").trim()}var jt=k('<span class="step-icon completed svelte-ugeeye">‚úì</span>'),It=k('<span class="step-icon custom svelte-ugeeye"> </span>'),Nt=k('<span class="step-number svelte-ugeeye"> </span>'),zt=k('<p class="step-description svelte-ugeeye"> </p>'),Ft=k('<div><div class="step-indicator svelte-ugeeye"><!></div> <div class="step-content svelte-ugeeye"><h3 class="step-title svelte-ugeeye"> </h3> <!></div></div>');function Rt(x,a){Fe(a,!1);const c=F(),i=F(),t=F(),g=F();let m=D(a,"step",8),_=D(a,"currentStep",8),h=D(a,"title",8),P=D(a,"description",8,""),p=D(a,"icon",8,void 0),w=D(a,"clickable",8,!1);function S(){if(w()){const Q=new CustomEvent("stepClick",{detail:{step:m()}});document.dispatchEvent(Q)}}X(()=>(v(m()),v(_())),()=>{n(c,m()===_())}),X(()=>(v(m()),v(_())),()=>{n(i,m()<_())}),X(()=>(v(m()),v(_())),()=>{n(t,m()>_())}),X(()=>(e(c),e(i),e(t),v(w())),()=>{n(g,["progress-step",e(c)&&"active",e(i)&&"completed",e(t)&&"pending",w()&&"clickable"].filter(Boolean).join(" "))}),Qe(),Ve();var $=Ft(),O=r($),M=r(O);{var j=Q=>{var W=jt();l(Q,W)},T=Q=>{var W=Ne(),ee=Se(W);{var pe=te=>{var ae=It(),he=r(ae,!0);s(ae),R(()=>U(he,p())),l(te,ae)},ce=te=>{var ae=Nt(),he=r(ae,!0);s(ae),R(()=>U(he,m())),l(te,ae)};N(ee,te=>{p()?te(pe):te(ce,!1)},!0)}l(Q,W)};N(M,Q=>{e(i)?Q(j):Q(T,!1)})}s(O);var L=d(O,2),I=r(L),z=r(I,!0);s(I);var H=d(I,2);{var be=Q=>{var W=zt(),ee=r(W,!0);s(W),R(()=>U(ee,P())),l(Q,W)};N(H,Q=>{P()&&Q(be)})}s(L),s($),R(()=>{ze($,1,et(e(g)),"svelte-ugeeye"),Pe($,"role",w()?"button":void 0),Pe($,"tabindex",w()?0:void 0),U(z,h())}),xe("click",$,S),xe("keydown",$,Q=>Q.key==="Enter"&&w()&&S()),l(x,$),Re()}var Vt=k("<div></div>"),Bt=k("<!> <!>",1),Ht=k('<div class="import-steps svelte-islpwy"><div class="steps-container svelte-islpwy"></div> <div class="progress-bar svelte-islpwy"><div class="progress-fill svelte-islpwy"></div></div></div>');function Lt(x,a){Fe(a,!1);let c=D(a,"currentStep",8,1),i=D(a,"allowStepNavigation",8,!1);const t=Ke(),g=[{step:1,title:"Subir archivo",description:"Selecciona y sube tu archivo CSV",icon:"üìÅ"},{step:2,title:"Previsualizar",description:"Revisa y selecciona las transacciones",icon:"üëÄ"},{step:3,title:"Completar",description:"Importa las transacciones seleccionadas",icon:"‚úÖ"}];function m({detail:w}){i()&&t("stepChange",{step:w.step})}X(()=>{},()=>{typeof document<"u"&&document.addEventListener("stepClick",m)}),Qe(),Ve();var _=Ht(),h=r(_);vt(h,5,()=>g,xt,(w,S,$)=>{var O=Bt(),M=Se(O);{var j=L=>{var I=Vt();let z;R(H=>z=ze(I,1,"step-connector svelte-islpwy",null,z,H),[()=>({completed:e(S).step<=c()})]),l(L,I)};N(M,L=>{$>0&&L(j)})}var T=d(M,2);Rt(T,{get step(){return e(S),b(()=>e(S).step)},get currentStep(){return c()},get title(){return e(S),b(()=>e(S).title)},get description(){return e(S),b(()=>e(S).description)},get icon(){return e(S),b(()=>e(S).icon)},get clickable(){return i()}}),l(w,O)}),s(h);var P=d(h,2),p=r(P);s(P),s(_),R(()=>Xe(p,`width: ${v(c()),b(()=>(c()-1)/(g.length-1)*100)??""}%`)),l(x,_),Re()}var Qt=k('<span class="stats-suffix svelte-16uke7m">transacciones</span>'),Ut=k('<div class="stats-details svelte-16uke7m"><span class="stats-suffix svelte-16uke7m">para importar</span> <span class="stats-percentage svelte-16uke7m"> </span></div>'),Ot=k('<div class="stats-details svelte-16uke7m"><span class="stats-suffix svelte-16uke7m">ya existen</span> <span class="stats-percentage svelte-16uke7m"> </span></div>'),qt=k('<span class="stats-suffix svelte-16uke7m">transacciones</span>'),Gt=k('<span class="stats-suffix svelte-16uke7m">con problemas</span>'),Wt=k('<div class="stats-summary svelte-16uke7m"><div class="summary-bar svelte-16uke7m"><div class="bar-segment selected svelte-16uke7m"></div> <div class="bar-segment duplicates svelte-16uke7m"></div> <div class="bar-segment remaining svelte-16uke7m"></div></div> <div class="summary-legend svelte-16uke7m"><div class="legend-item svelte-16uke7m"><div class="legend-color selected svelte-16uke7m"></div> <span class="legend-label svelte-16uke7m"> </span></div> <div class="legend-item svelte-16uke7m"><div class="legend-color duplicates svelte-16uke7m"></div> <span class="legend-label svelte-16uke7m"> </span></div> <div class="legend-item svelte-16uke7m"><div class="legend-color remaining svelte-16uke7m"></div> <span class="legend-label svelte-16uke7m"> </span></div></div></div>'),Jt=k('<div class="import-stats svelte-16uke7m"><div class="stats-grid svelte-16uke7m"><!> <!> <!> <!> <!></div> <!></div>');function Zt(x,a){Fe(a,!1);const c=F(),i=F();let t=D(a,"stats",8),g=D(a,"loading",8,!1),m=D(a,"showErrors",8,!1);X(()=>v(t()),()=>{n(c,t().total>0?Math.round(t().selected/t().total*100):0)}),X(()=>v(t()),()=>{n(i,t().total>0?Math.round(t().duplicates/t().total*100):0)}),Qe(),Ve();var _=Jt(),h=r(_),P=r(h);Ze(P,{label:"Total",get value(){return v(t()),b(()=>t().total)},currency:"",get loading(){return g()},children:(T,L)=>{var I=Qt();l(T,I)},$$slots:{default:!0}});var p=d(P,2);Ze(p,{label:"Seleccionadas",get value(){return v(t()),b(()=>t().selected)},currency:"",variant:"income",get loading(){return g()},children:(T,L)=>{var I=Ut(),z=d(r(I),2),H=r(z);s(z),s(I),R(()=>U(H,`(${e(c)??""}%)`)),l(T,I)},$$slots:{default:!0}});var w=d(p,2);Ze(w,{label:"Duplicadas",get value(){return v(t()),b(()=>t().duplicates)},currency:"",variant:"expense",get loading(){return g()},children:(T,L)=>{var I=Ot(),z=d(r(I),2),H=r(z);s(z),s(I),R(()=>U(H,`(${e(i)??""}%)`)),l(T,I)},$$slots:{default:!0}});var S=d(w,2);Ze(S,{label:"Nuevas",get value(){return v(t()),b(()=>t().new)},currency:"",variant:"balance",get loading(){return g()},children:(T,L)=>{var I=qt();l(T,I)},$$slots:{default:!0}});var $=d(S,2);{var O=T=>{Ze(T,{label:"Errores",get value(){return v(t()),b(()=>t().errors)},currency:"",variant:"expense",get loading(){return g()},children:(L,I)=>{var z=Gt();l(L,z)},$$slots:{default:!0}})};N($,T=>{v(m()),v(t()),b(()=>m()&&t().errors!==void 0)&&T(O)})}s(h);var M=d(h,2);{var j=T=>{var L=Wt(),I=r(L),z=r(I),H=d(z,2),be=d(H,2);s(I);var Q=d(I,2),W=r(Q),ee=d(r(W),2),pe=r(ee);s(ee),s(W);var ce=d(W,2),te=d(r(ce),2),ae=r(te);s(te),s(ce);var he=d(ce,2),De=d(r(he),2),y=r(De);s(De),s(he),s(Q),s(L),R(()=>{Xe(z,`width: ${v(t()),b(()=>t().selected/t().total*100)??""}%`),Pe(z,"title",`Seleccionadas: ${v(t()),b(()=>t().selected)??""}`),Xe(H,`width: ${v(t()),b(()=>t().duplicates/t().total*100)??""}%`),Pe(H,"title",`Duplicadas: ${v(t()),b(()=>t().duplicates)??""}`),Xe(be,`width: ${v(t()),b(()=>(t().total-t().selected-t().duplicates)/t().total*100)??""}%`),Pe(be,"title",`Sin seleccionar: ${v(t()),b(()=>t().total-t().selected-t().duplicates)??""}`),U(pe,`Seleccionadas (${v(t()),b(()=>t().selected)??""})`),U(ae,`Duplicadas (${v(t()),b(()=>t().duplicates)??""})`),U(y,`Sin seleccionar (${v(t()),b(()=>t().total-t().selected-t().duplicates)??""})`)}),l(T,L)};N(M,T=>{v(t()),v(g()),b(()=>t().total>0&&!g())&&T(j)})}s(_),l(x,_),Re()}var Kt=k('<div class="bulk-actions svelte-81ajht"><span class="selection-count svelte-81ajht"> </span> <div class="action-buttons svelte-81ajht"><!> <!> <!></div></div>'),Yt=k('<span class="status-badge error svelte-81ajht">‚ùå Error</span>'),Xt=k('<span class="status-badge duplicate svelte-81ajht">‚ö†Ô∏è Duplicada</span>'),ea=k('<span class="status-badge new svelte-81ajht">‚ú® Nueva</span>'),ta=k('<tr><td class="checkbox-col svelte-81ajht"><!></td><td class="date-col svelte-81ajht"><!></td><td class="merchant-col svelte-81ajht"><span class="merchant-name svelte-81ajht"> </span></td><td class="description-col svelte-81ajht"><span class="description-text svelte-81ajht"> </span></td><td class="amount-col svelte-81ajht"><!></td><td class="status-col svelte-81ajht"><!></td></tr>'),aa=k('<div class="show-more svelte-81ajht"><!></div>'),sa=k('<div class="table-container svelte-81ajht"><table class="transactions-table svelte-81ajht"><thead><tr><th class="checkbox-col svelte-81ajht"><!></th><th class="date-col svelte-81ajht">Fecha</th><th class="merchant-col svelte-81ajht">Comercio</th><th class="description-col svelte-81ajht">Descripci√≥n</th><th class="amount-col svelte-81ajht">Importe</th><th class="status-col svelte-81ajht">Estado</th></tr></thead><tbody></tbody></table></div> <!>',1),ra=k('<div class="empty-state svelte-81ajht"><div class="empty-icon svelte-81ajht">üîç</div> <h3 class="empty-title svelte-81ajht">No se encontraron transacciones</h3> <p class="empty-message svelte-81ajht"><!></p></div>'),la=k('<div><div class="table-header svelte-81ajht"><div class="header-controls svelte-81ajht"><!> <!></div> <!></div> <!></div>');function na(x,a){Fe(a,!1);const c=F(),i=F(),t=F(),g=F(),m=F(),_=F(),h=F(),P=F();let p=D(a,"transactions",24,()=>[]),w=D(a,"searchQuery",12,""),S=D(a,"viewMode",12,"all"),$=D(a,"showAllTransactions",12,!1),O=D(a,"pageSize",8,50),M=D(a,"loading",8,!1);const j=Ke();function T({detail:f}){w(f.value),j("searchChange",{searchQuery:w()})}function L({detail:f}){const E=f.filterId;S(E),j("viewModeChange",{viewMode:E})}function I(f){j("transactionToggle",{transactionId:f.id,selected:!f.selected})}function z(){const f=e(_)?"deselectAll":"selectAll";j(f,{transactionIds:e(t).map(E=>E.id)})}function H(){j("deselectAll",{transactionIds:p().map(f=>f.id)})}function be(){const f=p().filter(E=>!E.isDuplicate).map(E=>E.id);j("selectAll",{transactionIds:f})}function Q(){$(!0),j("showAll")}X(()=>(v(S()),v(p())),()=>{n(c,[{id:"all",label:"Todas",active:S()==="all",count:p().length,variant:"default"},{id:"new",label:"Nuevas",active:S()==="new",count:p().filter(f=>!f.isDuplicate).length,variant:"income"},{id:"duplicates",label:"Duplicadas",active:S()==="duplicates",count:p().filter(f=>f.isDuplicate).length,variant:"expense"}])}),X(()=>(v(p()),v(S()),v(w())),()=>{n(i,(()=>{let f=p();if(S()==="new"?f=f.filter(E=>!E.isDuplicate):S()==="duplicates"&&(f=f.filter(E=>E.isDuplicate)),w().trim()){const E=w().toLowerCase();f=f.filter(G=>G.merchant.toLowerCase().includes(E)||G.description?.toLowerCase().includes(E)||G.amount.toString().includes(E)||G.date.includes(E))}return f})())}),X(()=>(v($()),e(i),v(O())),()=>{n(t,$()?e(i):e(i).slice(0,O()))}),X(()=>(e(i),v(O())),()=>{n(g,e(i).length>O())}),X(()=>v(p()),()=>{n(m,p().filter(f=>f.selected).length)}),X(()=>e(t),()=>{n(_,e(t).length>0&&e(t).every(f=>f.selected))}),X(()=>e(t),()=>{n(h,e(t).some(f=>f.selected))}),X(()=>v(M()),()=>{n(P,["import-transaction-table",M()&&"loading"].filter(Boolean).join(" "))}),Qe(),Ve();var W=la(),ee=r(W),pe=r(ee),ce=r(pe);kt(ce,{get value(){return w()},placeholder:"Buscar transacciones...",get loading(){return M()},$$events:{input:T}});var te=d(ce,2);$t(te,{get filters(){return e(c)},allowClear:!1,allowMultiple:!1,$$events:{change:L}}),s(pe);var ae=d(pe,2);{var he=f=>{var E=Kt(),G=r(E),we=r(G);s(G);var de=d(G,2),ve=r(de);Ae(ve,{variant:"outline",size:"sm",$$events:{click:z},children:(J,ue)=>{_e();var ge=oe();R(()=>U(ge,`${e(_)?"Deseleccionar":"Seleccionar"} visibles`)),l(J,ge)},$$slots:{default:!0}});var o=d(ve,2);Ae(o,{variant:"outline",size:"sm",$$events:{click:be},children:(J,ue)=>{_e();var ge=oe("Seleccionar nuevas");l(J,ge)},$$slots:{default:!0}});var C=d(o,2);Ae(C,{variant:"outline",size:"sm",$$events:{click:H},children:(J,ue)=>{_e();var ge=oe("Deseleccionar todas");l(J,ge)},$$slots:{default:!0}}),s(de),s(E),R(()=>U(we,`${e(m)??""} de ${v(p()),b(()=>p().length)??""} seleccionadas`)),l(f,E)};N(ae,f=>{v(p()),b(()=>p().length>0)&&f(he)})}s(ee);var De=d(ee,2);{var y=f=>{var E=sa(),G=Se(E),we=r(G),de=r(we),ve=r(de),o=r(ve),C=r(o);{let Z=dt(()=>e(h)&&!e(_));nt(C,{get checked(){return e(_)},get indeterminate(){return e(Z)},$$events:{change:z}})}s(o),_e(5),s(ve),s(de);var J=d(de);vt(J,5,()=>e(t),Z=>Z.id,(Z,A)=>{var ke=ta();let Me;var V=r(ke),u=r(V);nt(u,{get checked(){return e(A),b(()=>e(A).selected)},get disabled(){return e(A),b(()=>e(A).isDuplicate)},$$events:{change:()=>I(e(A))}}),s(V);var B=d(V),se=r(B);Ct(se,{get date(){return e(A),b(()=>e(A).date)},format:"short"}),s(B);var re=d(B),Te=r(re),le=r(Te,!0);s(Te),s(re);var ne=d(re),$e=r(ne),ie=r($e,!0);s($e),s(ne);var Y=d(ne),fe=r(Y);Dt(fe,{get amount(){return e(A),b(()=>e(A).amount)},get currency(){return e(A),b(()=>e(A).currency)},size:"sm"}),s(Y);var me=d(Y),je=r(me);{var Ie=K=>{var Ce=Yt();R(()=>Pe(Ce,"title",(e(A),b(()=>e(A).errorMessage)))),l(K,Ce)},ye=K=>{var Ce=Ne(),Be=Se(Ce);{var qe=Ee=>{var We=Xt();l(Ee,We)},Ge=Ee=>{var We=ea();l(Ee,We)};N(Be,Ee=>{e(A),b(()=>e(A).isDuplicate)?Ee(qe):Ee(Ge,!1)},!0)}l(K,Ce)};N(je,K=>{e(A),b(()=>e(A).hasError)?K(Ie):K(ye,!1)})}s(me),s(ke),R(K=>{Me=ze(ke,1,"transaction-row svelte-81ajht",null,Me,K),U(le,(e(A),b(()=>e(A).merchant))),U(ie,(e(A),b(()=>e(A).description||"-")))},[()=>({selected:e(A).selected,duplicate:e(A).isDuplicate,error:e(A).hasError})]),l(Z,ke)}),s(J),s(we),s(G);var ue=d(G,2);{var ge=Z=>{var A=aa(),ke=r(A);Ae(ke,{variant:"outline",$$events:{click:Q},children:(Me,V)=>{_e();var u=oe();R(()=>U(u,`Mostrar todas las transacciones (${e(i),v(O()),b(()=>e(i).length-O())??""} m√°s)`)),l(Me,u)},$$slots:{default:!0}}),s(A),l(Z,A)};N(ue,Z=>{e(g)&&!$()&&Z(ge)})}l(f,E)},q=f=>{var E=ra(),G=d(r(E),4),we=r(G);{var de=o=>{var C=oe();R(()=>U(C,`No hay transacciones que coincidan con "${w()??""}"`)),l(o,C)},ve=o=>{var C=Ne(),J=Se(C);{var ue=Z=>{var A=oe("No hay transacciones duplicadas");l(Z,A)},ge=Z=>{var A=Ne(),ke=Se(A);{var Me=u=>{var B=oe("No hay transacciones nuevas");l(u,B)},V=u=>{var B=oe("No hay transacciones para mostrar");l(u,B)};N(ke,u=>{S()==="new"?u(Me):u(V,!1)},!0)}l(Z,A)};N(J,Z=>{S()==="duplicates"?Z(ue):Z(ge,!1)},!0)}l(o,C)};N(we,o=>{w()?o(de):o(ve,!1)})}s(G),s(E),l(f,E)};N(De,f=>{e(t),b(()=>e(t).length>0)?f(y):f(q,!1)})}s(W),R(()=>ze(W,1,et(e(P)),"svelte-81ajht")),l(x,W),Re()}var ia=k('<p class="primary-text svelte-1exfyoi">Suelta el archivo aqu√≠</p>'),oa=k('<p class="primary-text svelte-1exfyoi"><!></p> <p class="secondary-text svelte-1exfyoi"><!></p>',1),ca=k('<input type="file" style="display: none;" class="svelte-1exfyoi"/> <div role="button" aria-label="Zona de carga de archivos"><div class="upload-content svelte-1exfyoi"><div class="upload-icon svelte-1exfyoi"><!></div> <div class="upload-text svelte-1exfyoi"><!></div> <!></div></div>',1);function da(x,a){Fe(a,!1);const c=F();let i=D(a,"acceptedTypes",8,".csv"),t=D(a,"maxSize",8,10*1024*1024),g=D(a,"disabled",8,!1),m=D(a,"multiple",8,!1),_=D(a,"dragActive",12,!1);const h=Ke();let P=F(),p=F(!1);function w(y){y.preventDefault(),y.stopPropagation(),g()||(n(p,!0),_(!0))}function S(y){y.preventDefault(),y.stopPropagation(),g()||(n(p,!1),_(!1))}function $(y){y.preventDefault(),y.stopPropagation()}function O(y){if(y.preventDefault(),y.stopPropagation(),g())return;n(p,!1),_(!1);const q=Array.from(y.dataTransfer?.files||[]);j(q)}function M(y){const q=y.target,f=Array.from(q.files||[]);j(f)}function j(y){if(y.length===0)return;const q=y[0],f=T(q);f.valid?h("fileSelected",{file:q}):h("fileError",{error:f.error,file:q})}function T(y){const q="."+y.name.split(".").pop()?.toLowerCase();return i().split(",").map(E=>E.trim().toLowerCase()).includes(q)?y.size>t()?{valid:!1,error:`El archivo es demasiado grande. M√°ximo: ${Math.round(t()/1048576)}MB`}:{valid:!0}:{valid:!1,error:`Tipo de archivo no v√°lido. Se acepta: ${i()}`}}function L(){g()||e(P)?.click()}X(()=>(v(g()),e(p)),()=>{n(c,["file-upload-zone",g()&&"disabled",e(p)&&"drag-over"].filter(Boolean).join(" "))}),Qe(),Ve();var I=ca(),z=Se(I);Tt(z,y=>n(P,y),()=>e(P));var H=d(z,2),be=r(H),Q=r(be),W=r(Q);{var ee=y=>{var q=oe("üìÇ");l(y,q)},pe=y=>{var q=oe("üìÅ");l(y,q)};N(W,y=>{e(p)?y(ee):y(pe,!1)})}s(Q);var ce=d(Q,2),te=r(ce);{var ae=y=>{var q=ia();l(y,q)},he=y=>{var q=oa(),f=Se(q),E=r(f);Oe(E,a,"title",{},de=>{var ve=oe("Arrastra un archivo aqu√≠ o haz clic para seleccionar");l(de,ve)}),s(f);var G=d(f,2),we=r(G);Oe(we,a,"subtitle",{},de=>{var ve=oe();R(o=>U(ve,`Formatos aceptados: ${i()??""} ‚Ä¢ M√°ximo ${o??""}MB`),[()=>(v(t()),b(()=>Math.round(t()/1048576)))]),l(de,ve)}),s(G),l(y,q)};N(te,y=>{e(p)?y(ae):y(he,!1)})}s(ce);var De=d(ce,2);Oe(De,a,"extra",{},null),s(be),s(H),R(()=>{Pe(z,"accept",i()),z.multiple=m(),z.disabled=g(),ze(H,1,et(e(c)),"svelte-1exfyoi"),Pe(H,"tabindex",g()?-1:0)}),xe("change",z,M),xe("dragenter",H,w),xe("dragleave",H,S),xe("dragover",H,$),xe("drop",H,O),xe("click",H,L),xe("keydown",H,y=>y.key==="Enter"&&L()),l(x,I),Re()}var va=k('<div class="flex items-center justify-center h-full text-acapulco"><svg class="w-2.5 h-2.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg></div>'),ua=k("<label> </label>"),pa=k('<div class="flex items-center space-x-3"><button type="button" role="switch"><span><!></span></button> <!></div>');function fa(x,a){Fe(a,!1);let c=D(a,"checked",12,!1),i=D(a,"disabled",8,!1),t=D(a,"label",8,""),g=D(a,"size",8,"md");const m=Ke();function _(){i()||(c(!c()),m("change",c()))}const h={sm:{toggle:"w-8 h-5",thumb:"w-4 h-4",translate:c()?"translate-x-3":"translate-x-0"},md:{toggle:"w-11 h-6",thumb:"w-5 h-5",translate:c()?"translate-x-5":"translate-x-0"}};Ve();var P=pa(),p=r(P),w=r(p),S=r(w);{var $=j=>{var T=va();l(j,T)};N(S,j=>{c()&&j($)})}s(w),s(p);var O=d(p,2);{var M=j=>{var T=ua(),L=r(T,!0);s(T),R(()=>{ze(T,1,`text-sm font-medium text-evening-sea cursor-pointer ${i()?"opacity-50":""}`),U(L,t())}),xe("click",T,function(...I){(i()?null:_)?.apply(this,I)}),l(j,T)};N(O,j=>{t()&&j(M)})}s(P),R(()=>{Pe(p,"aria-checked",c()),Pe(p,"aria-label",t()),ze(p,1,`relative inline-flex rounded-full transition-all duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-acapulco/30 focus:ring-offset-2 
      ${v(g()),b(()=>h[g()].toggle)??""}
      ${c()?"bg-acapulco":"bg-evening-sea/20"}
      ${i()?"opacity-50 cursor-not-allowed":"cursor-pointer"}
    `),p.disabled=i(),ze(w,1,`inline-block rounded-full bg-bridesmaid shadow-lg transform transition-all duration-300 ease-in-out
        ${v(g()),b(()=>h[g()].thumb)??""}
        ${v(g()),b(()=>h[g()].translate)??""}
        ${c()?"shadow-acapulco/20":"shadow-evening-sea/10"}
      `)}),xe("click",p,_),xe("keydown",p,j=>j.key==="Enter"&&_()),l(x,P),Re()}var ha=k('<div class="error-alert svelte-1s86sg8"><span class="error-icon svelte-1s86sg8">‚ùå</span> <span class="error-message svelte-1s86sg8"> </span> <button class="error-close svelte-1s86sg8" aria-label="Cerrar error">√ó</button></div>'),ga=k('<div class="file-info svelte-1s86sg8"><div class="file-details svelte-1s86sg8"><span class="file-icon svelte-1s86sg8">üìÑ</span> <div class="file-text svelte-1s86sg8"><span class="file-name svelte-1s86sg8"> </span> <span class="file-size svelte-1s86sg8"> </span></div></div> <!></div>'),ma=k('<span slot="title">Arrastra tu archivo CSV aqu√≠ o haz clic para seleccionar</span>'),_a=k('<span slot="subtitle">Archivos CSV ‚Ä¢ M√°ximo 10MB</span>'),ba=k('<div class="upload-step svelte-1s86sg8"><div class="upload-settings svelte-1s86sg8"><label class="setting-item svelte-1s86sg8"><span class="setting-label svelte-1s86sg8">Previsualizar antes de importar</span> <!></label> <p class="setting-help svelte-1s86sg8">Si est√° desactivado, las transacciones se importar√°n directamente sin previsualizaci√≥n</p></div> <!></div>'),wa=k('<div class="preview-step svelte-1s86sg8"><!> <!></div>'),ya=k('<div class="importing-state svelte-1s86sg8"><div class="loading-spinner svelte-1s86sg8"></div> <h3 class="importing-title svelte-1s86sg8">Importando transacciones...</h3> <p class="importing-message svelte-1s86sg8"> </p></div>'),xa=k('<div class="result-item svelte-1s86sg8"><span class="result-value svelte-1s86sg8"> </span> <span class="result-label svelte-1s86sg8">duplicadas</span></div>'),Sa=k('<div class="result-item error svelte-1s86sg8"><span class="result-value svelte-1s86sg8"> </span> <span class="result-label svelte-1s86sg8">errores</span></div>'),ka=k('<div class="import-success svelte-1s86sg8"><div class="success-icon svelte-1s86sg8">‚úÖ</div> <h3 class="success-title svelte-1s86sg8">¬°Importaci√≥n completada!</h3> <p class="success-message svelte-1s86sg8"> </p> <div class="result-stats svelte-1s86sg8"><div class="result-item svelte-1s86sg8"><span class="result-value svelte-1s86sg8"> </span> <span class="result-label svelte-1s86sg8">importadas</span></div> <!> <!></div></div>'),$a=k('<div class="complete-step svelte-1s86sg8"><!></div>'),Ca=k('<div class="final-actions svelte-1s86sg8"><!> <!></div>'),Da=k('<div><header class="page-header svelte-1s86sg8"><h1 class="page-title svelte-1s86sg8">Importar transacciones</h1> <p class="page-subtitle svelte-1s86sg8">Sube un archivo CSV para importar tus transacciones de forma masiva</p></header> <!> <!> <main class="step-content svelte-1s86sg8"><!> <!></main> <footer class="page-footer svelte-1s86sg8"><div class="footer-actions svelte-1s86sg8"><!> <!></div> <!></footer> <!></div>');function Ta(x,a){Fe(a,!1);const c=F();let i=D(a,"currentStep",8,1),t=D(a,"selectedFile",8,null),g=D(a,"transactions",24,()=>[]),m=D(a,"stats",8),_=D(a,"searchQuery",8,""),h=D(a,"viewMode",8,"all"),P=D(a,"showAllTransactions",8,!1),p=D(a,"previewEnabled",8,!0),w=D(a,"loading",8,!1),S=D(a,"importing",8,!1),$=D(a,"importResult",8,null),O=D(a,"error",8,"");const M=Ke();function j({detail:u}){M("stepChange",u)}function T({detail:u}){M("fileSelected",u)}function L({detail:u}){M("fileError",u)}function I(){M("removeFile")}function z({detail:u}){M("previewToggle",{enabled:u.checked})}function H({detail:u}){M("searchChange",u)}function be({detail:u}){M("viewModeChange",u)}function Q({detail:u}){M("transactionToggle",u)}function W({detail:u}){M("selectAll",u)}function ee({detail:u}){M("deselectAll",u)}function pe(){M("showAll")}function ce(){M("next")}function te(){M("previous")}function ae(){M("import")}function he(){M("restart")}function De(){M("goHome")}X(()=>(v(w()),v(S())),()=>{n(c,["import-page-template",w()&&"loading",S()&&"importing"].filter(Boolean).join(" "))}),Qe(),Ve();var y=Da(),q=d(r(y),2);{let u=dt(()=>i()>1);Lt(q,{get currentStep(){return i()},get allowStepNavigation(){return e(u)},$$events:{stepChange:j}})}var f=d(q,2);{var E=u=>{var B=ha(),se=d(r(B),2),re=r(se,!0);s(se);var Te=d(se,2);s(B),R(()=>U(re,O())),xe("click",Te,()=>M("clearError")),l(u,B)};N(f,u=>{O()&&u(E)})}var G=d(f,2),we=r(G);{var de=u=>{var B=ba(),se=r(B),re=r(se),Te=d(r(re),2);fa(Te,{get checked(){return p()},$$events:{change:z}}),s(re),_e(2),s(se);var le=d(se,2);{var ne=ie=>{var Y=ga(),fe=r(Y),me=d(r(fe),2),je=r(me),Ie=r(je,!0);s(je);var ye=d(je,2),K=r(ye);s(ye),s(me),s(fe);var Ce=d(fe,2);Ae(Ce,{variant:"ghost",icon:"√ó","aria-label":"Eliminar archivo",$$events:{click:I}}),s(Y),R(Be=>{U(Ie,(v(t()),b(()=>t().name))),U(K,`${Be??""} MB`)},[()=>(v(t()),b(()=>(t().size/1024/1024).toFixed(2)))]),l(ie,Y)},$e=ie=>{da(ie,{acceptedTypes:".csv",maxSize:10485760,get loading(){return w()},$$events:{fileSelected:T,fileError:L},$$slots:{title:(Y,fe)=>{var me=ma();l(Y,me)},subtitle:(Y,fe)=>{var me=_a();l(Y,me)}}})};N(le,ie=>{t()?ie(ne):ie($e,!1)})}s(B),l(u,B)},ve=u=>{var B=Ne(),se=Se(B);{var re=le=>{var ne=wa(),$e=r(ne);Zt($e,{get stats(){return m()},get loading(){return w()}});var ie=d($e,2);na(ie,{get transactions(){return g()},get searchQuery(){return _()},get viewMode(){return h()},get showAllTransactions(){return P()},get loading(){return w()},$$events:{searchChange:H,viewModeChange:be,transactionToggle:Q,selectAll:W,deselectAll:ee,showAll:pe}}),s(ne),l(le,ne)},Te=le=>{var ne=Ne(),$e=Se(ne);{var ie=Y=>{var fe=$a(),me=r(fe);{var je=ye=>{var K=ya(),Ce=d(r(K),4),Be=r(Ce);s(Ce),s(K),R(()=>U(Be,`Procesando ${v(m()),b(()=>m().selected)??""} transacciones. Por favor espera.`)),l(ye,K)},Ie=ye=>{var K=Ne(),Ce=Se(K);{var Be=qe=>{var Ge=ka(),Ee=d(r(Ge),4),We=r(Ee,!0);s(Ee);var st=d(Ee,2),tt=r(st),rt=r(tt),ut=r(rt,!0);s(rt),_e(2),s(tt);var lt=d(tt,2);{var pt=He=>{var Le=xa(),Je=r(Le),at=r(Je,!0);s(Je),_e(2),s(Le),R(()=>U(at,(v($()),b(()=>$().duplicates)))),l(He,Le)};N(lt,He=>{v($()),b(()=>$().duplicates>0)&&He(pt)})}var ft=d(lt,2);{var ht=He=>{var Le=Sa(),Je=r(Le),at=r(Je,!0);s(Je),_e(2),s(Le),R(()=>U(at,(v($()),b(()=>$().errors)))),l(He,Le)};N(ft,He=>{v($()),b(()=>$().errors>0)&&He(ht)})}s(st),s(Ge),R(()=>{U(We,(v($()),b(()=>$().message))),U(ut,(v($()),b(()=>$().imported)))}),l(qe,Ge)};N(Ce,qe=>{$()&&qe(Be)},!0)}l(ye,K)};N(me,ye=>{S()?ye(je):ye(Ie,!1)})}s(fe),l(Y,fe)};N($e,Y=>{i()===3&&Y(ie)},!0)}l(le,ne)};N(se,le=>{i()===2?le(re):le(Te,!1)},!0)}l(u,B)};N(we,u=>{i()===1?u(de):u(ve,!1)})}var o=d(we,2);Oe(o,a,"content",{},null),s(G);var C=d(G,2),J=r(C),ue=r(J);{var ge=u=>{Ae(u,{variant:"outline",$$events:{click:te},children:(B,se)=>{_e();var re=oe("Anterior");l(B,re)},$$slots:{default:!0}})};N(ue,u=>{i()>1&&!S()&&u(ge)})}var Z=d(ue,2);{var A=u=>{Ae(u,{variant:"primary",get loading(){return w()},$$events:{click:ce},children:(B,se)=>{_e();var re=oe();R(()=>U(re,p()?"Previsualizar":"Importar directamente")),l(B,re)},$$slots:{default:!0}})},ke=u=>{var B=Ne(),se=Se(B);{var re=le=>{Ae(le,{variant:"primary",$$events:{click:ae},children:(ne,$e)=>{_e();var ie=oe();R(()=>U(ie,`Importar ${v(m()),b(()=>m().selected)??""} transacciones`)),l(ne,ie)},$$slots:{default:!0}})},Te=le=>{var ne=Ne(),$e=Se(ne);{var ie=Y=>{var fe=Ca(),me=r(fe);Ae(me,{variant:"outline",$$events:{click:he},children:(Ie,ye)=>{_e();var K=oe("Importar m√°s archivos");l(Ie,K)},$$slots:{default:!0}});var je=d(me,2);Ae(je,{variant:"primary",$$events:{click:De},children:(Ie,ye)=>{_e();var K=oe("Ver transacciones");l(Ie,K)},$$slots:{default:!0}}),s(fe),l(Y,fe)};N($e,Y=>{i()===3&&$()&&!S()&&Y(ie)},!0)}l(le,ne)};N(se,le=>{v(i()),v(m()),b(()=>i()===2&&m().selected>0)?le(re):le(Te,!1)},!0)}l(u,B)};N(Z,u=>{i()===1&&t()?u(A):u(ke,!1)})}s(J);var Me=d(J,2);Oe(Me,a,"footer",{},null),s(C);var V=d(C,2);Oe(V,a,"modals",{},null),s(y),R(()=>ze(y,1,et(e(c)),"svelte-1s86sg8")),l(x,y),Re()}function Ba(x,a){Fe(a,!1);const c=()=>wt(St,"$t",i),[i,t]=bt(),g="import-preview-enabled";let m=F(1),_=F(null),h=F([]),P=F(!1),p=F(!1),w=F(""),S=F(!0),$=F(!1),O=F(""),M=F("all"),j=F(null),T=F(!1);function L(){if(typeof localStorage<"u"){const o=localStorage.getItem(g);return o!==null?JSON.parse(o):!0}return!0}function I(o){typeof localStorage<"u"&&localStorage.setItem(g,JSON.stringify(o))}gt(()=>{n(S,L()),n(T,!0)});async function z(o){const C=await o.text(),J=At(C);if(J.errors.length>0&&(console.warn("CSV parsing errors:",J.errors),J.errors.forEach(V=>{console.warn(`Row ${V.row}: ${V.message}`)})),J.transactions.length===0)throw new Error("No valid transactions found in CSV file");const ue=J.transactions.map(V=>({date:V.date,merchant:V.partner,amount:V.amount,currency:"EUR"})),ge=await Ye.generateHashes(ue),Z=J.transactions.map((V,u)=>{const B=ge.hashes.find(se=>se.index===u);return{...V,hash:B?.hash||V.hash}}),A=Z.map(V=>V.hash),ke=await Ye.checkDuplicates(A);return Z.map(V=>{const u=ke.results.find(B=>B.hash===V.hash);return{id:V.id,date:V.date,merchant:V.partner,description:V.description,amount:V.amount,currency:"EUR",selected:!(u?.isDuplicate||V.isDuplicate),isDuplicate:u?.isDuplicate||V.isDuplicate,hasError:!1,errorMessage:void 0}})}async function H({detail:o}){const C=o.file;if(!C.name.toLowerCase().endsWith(".csv")){n(w,c()("import.errors.invalid_file"));return}if(C.size>10*1024*1024){n(w,c()("import.errors.file_too_large"));return}n(_,C),n(w,""),e(S)?await ee():await pe()}function be({detail:o}){n(w,o.error)}function Q(){n(_,null),n(h,[]),n(m,1),n(w,"")}function W({detail:o}){n(S,o.enabled)}async function ee(){if(e(_)){n(P,!0),n(w,"");try{if(n(h,await z(e(_))),e(h).length===0){n(w,c()("import.errors.no_transactions"));return}n(m,2)}catch(o){n(w,o instanceof Error?o.message:c()("import.errors.parse_failed")),console.error(o)}finally{n(P,!1)}}}async function pe(){if(e(_)){n(P,!0),n(p,!0),n(m,3);try{let o;if(e(h).length===0)o=await Ye.importFile(e(_),{currency:"EUR",duplicateDetectionEnabled:!0,skipDuplicates:!0,autoCategorizationEnabled:!0}),n(j,{success:!0,imported:o.imported||0,duplicates:o.duplicatesSkipped||0,errors:0,message:c()("import.complete.success_desc",{count:o.imported||0})});else{const C=e(h).filter(ue=>ue.selected),J=e(h).filter(ue=>ue.isDuplicate&&!ue.selected).length;if(C.length===0)throw new Error("No transactions selected for import");o=await Ye.importSelectedTransactions(C),n(j,{success:!0,imported:C.length,duplicates:J,errors:0,message:c()("import.complete.success_desc",{count:C.length})})}await new Promise(C=>setTimeout(C,1500))}catch(o){n(w,c()("import.errors.import_failed")),console.error(o),n(m,2),n(j,{success:!1,imported:0,duplicates:0,errors:1,message:c()("import.errors.import_failed")})}finally{n(P,!1),n(p,!1)}}}function ce({detail:o}){n(O,o.searchQuery)}function te({detail:o}){n(M,o.viewMode)}function ae({detail:o}){n(h,e(h).map(C=>C.id===o.transactionId?{...C,selected:o.selected}:C))}function he({detail:o}){n(h,e(h).map(C=>o.transactionIds.includes(C.id)?{...C,selected:!0}:C))}function De({detail:o}){n(h,e(h).map(C=>o.transactionIds.includes(C.id)?{...C,selected:!1}:C))}function y(){n($,!0)}function q({detail:o}){o.step<e(m)&&n(m,o.step)}function f(){e(m)===1&&e(_)&&(e(S)?ee():pe())}function E(){e(m)===2&&(n(m,1),n(h,[]),n(w,""))}function G(){pe()}function we(){n(_,null),n(h,[]),n(m,1),n(j,null),n(w,""),n($,!1),n(O,""),n(M,"all")}function de(){yt("/")}function ve(){n(w,"")}X(()=>e(h),()=>{ImportStatistics={total:e(h).length,selected:e(h).filter(o=>o.selected).length,duplicates:e(h).filter(o=>o.isDuplicate).length,new:e(h).filter(o=>!o.isDuplicate).length,errors:e(h).filter(o=>o.hasError).length}}),X(()=>(e(T),e(S)),()=>{e(T)&&typeof localStorage<"u"&&I(e(S))}),Qe(),Ve(),mt(o=>{R(C=>_t.title=`${C??""} - Happy Balance`,[()=>(c(),b(()=>c()("import.title")))])}),Ta(x,{get currentStep(){return e(m)},get selectedFile(){return e(_)},get transactions(){return e(h)},stats,get searchQuery(){return e(O)},get viewMode(){return e(M)},get showAllTransactions(){return e($)},get previewEnabled(){return e(S)},get loading(){return e(P)},get importing(){return e(p)},get importResult(){return e(j)},get error(){return e(w)},$$events:{fileSelected:H,fileError:be,removeFile:Q,previewToggle:W,searchChange:ce,viewModeChange:te,transactionToggle:ae,selectAll:he,deselectAll:De,showAll:y,stepChange:q,next:f,previous:E,import:G,restart:we,goHome:de,clearError:ve}}),Re(),t()}export{Ba as component};
