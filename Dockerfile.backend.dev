FROM node:20-alpine

# Install pnpm
RUN corepack enable && corepack prepare pnpm@9.0.0 --activate

# Set working directory
WORKDIR /app

# Install dumb-init for proper signal handling
RUN apk add --no-cache dumb-init

# Copy workspace configuration
COPY package.json pnpm-workspace.yaml ./

# The source code will be mounted as a volume
# node_modules will be in named volumes to avoid conflicts

EXPOSE 3004

# Use dumb-init to handle signals properly
ENTRYPOINT ["dumb-init", "--"]
CMD ["sh", "-c", "cd /app/apps/backend && pnpm install && pnpm dev"]
